<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Trust Fund - Savings Group Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-link {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .notification-dot {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .editable-cell input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #4f46e5;
            border-radius: 4px;
            text-align: right;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .status-present { background-color: #dcfce7; color: #166534; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-late { background-color: #fef3c7; color: #92400e; }
        .status-none { background-color: #f3f4f6; color: #6b7280; }
        .attendance-cell {
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            width: 60px; /* fixed width for cells */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Page -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md">
            <div id="auth-loader" class="text-center hidden">
                <div class="loader inline-block"></div>
                <p class="mt-4 text-gray-600">Please wait...</p>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" class="bg-white shadow-lg rounded-xl px-8 pt-6 pb-8 mb-4">
                <div class="mb-8 text-center">
                    <svg class="w-16 h-16 mx-auto text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <h1 class="text-3xl font-bold text-gray-800 mt-2">The Trust Fund</h1>
                    <p class="text-gray-500">Please sign in to continue</p>
                </div>
                <p id="login-error" class="text-red-500 text-xs text-center mb-4 hidden"></p>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-email">Email</label>
                    <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" id="login-email" type="email" placeholder="email@example.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">Password</label>
                    <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" id="login-password" type="password" placeholder="******************" required>
                </div>
                <div class="flex items-center justify-between">
                    <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline" type="submit">Sign In</button>
                </div>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Create one</a>
                </p>
            </form>

            <!-- Registration Form -->
            <form id="register-form" class="bg-white shadow-lg rounded-xl px-8 pt-6 pb-8 mb-4 hidden">
                 <div class="mb-8 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Create Account</h1>
                    <p class="text-gray-500">Join The Trust Fund</p>
                </div>
                 <p id="register-error" class="text-red-500 text-xs text-center mb-4 hidden"></p>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-name">Full Name</label>
                    <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" id="register-name" type="text" placeholder="John Doe" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-email">Email</label>
                    <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" id="register-email" type="email" placeholder="email@example.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">Password</label>
                    <input class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" id="register-password" type="password" placeholder="******************" required>
                </div>
                <div class="flex items-center justify-between">
                    <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline" type="submit">Create Account</button>
                </div>
                 <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                </p>
            </form>

             <p class="text-center text-gray-500 text-xs">
                &copy;2025 The Trust Fund. All rights reserved.
            </p>
        </div>
    </div>


    <!-- Main Application -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-white flex flex-col">
                <div class="p-4 text-2xl font-bold border-b border-gray-700 flex items-center space-x-3">
                    <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>The Trust Fund</span>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" id="nav-dashboard" class="sidebar-link active flex items-center p-3 rounded-lg">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                     <a href="#" id="nav-deposit" class="sidebar-link flex items-center p-3 rounded-lg">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm-5-12v-2m0 4h.01"></path></svg>
                        Declaration
                    </a>
                    <a href="#" id="nav-request-loan" class="sidebar-link flex items-center p-3 rounded-lg">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Request Loan
                    </a>
                     <a href="#" id="nav-my-loans" class="sidebar-link flex items-center p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 10v-1h12v1a2 2 0 01-2 2H6a2 2 0 01-2-2z" /></svg>
                        My Loans
                    </a>
                    <a href="#" id="nav-recon" class="sidebar-link flex items-center p-3 rounded-lg">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 5h.01M12 5h.01M9 5h.01M4 7h16a1 1 0 011 1v10a1 1 0 01-1 1H4a1 1 0 01-1-1V8a1 1 0 011-1z"></path></svg>
                        Loan Recon
                    </a>
                    <a href="#" id="nav-future" class="sidebar-link flex items-center p-3 rounded-lg">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        Future Value
                    </a>
                    <a href="#" id="nav-penalties" class="sidebar-link flex items-center p-3 rounded-lg">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Penalties
                    </a>
                    <a href="#" id="nav-admin" class="sidebar-link flex items-center p-3 rounded-lg hidden">
                       <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                        Admin Approvals
                    </a>
                    <a href="#" id="nav-transactions" class="sidebar-link flex items-center p-3 rounded-lg hidden">
                       <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Transactions
                    </a>
                </nav>
            </aside>
    
            <!-- Main Content -->
            <main class="flex-1 flex flex-col">
                <!-- Header -->
                <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                    <h1 id="header-title" class="text-2xl font-semibold text-gray-700">Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="notification-bell" class="relative p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                                 <span id="notification-indicator" class="notification-dot hidden"></span>
                            </button>
                            <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg border z-10">
                                <div class="p-3 border-b font-semibold">Notifications</div>
                                <div id="notification-list" class="p-2 max-h-96 overflow-y-auto">
                                    <!-- Notifications will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        <div id="user-info" class="text-right">
                            <!-- User info is dynamic -->
                        </div>
                        <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
                    </div>
                </header>
    
                <!-- Page Content -->
                <div class="flex-1 p-6 overflow-y-auto">
                    
                    <!-- Universal Loader -->
                    <div id="view-loader" class="text-center p-10">
                        <div class="loader inline-block"></div>
                        <p class="mt-4 text-gray-600">Loading Data...</p>
                    </div>

                    <!-- Dashboard View -->
                    <div id="view-dashboard" class="hidden">
                        <!-- Stat Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white p-6 rounded-xl shadow-md text-center">
                                <h3 class="text-gray-500 font-medium">Total Group Savings</h3>
                                <p id="group-savings-stat" class="text-3xl font-bold text-indigo-600">ZMW 0.00</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md text-center">
                                <h3 class="text-gray-500 font-medium">Funds Available for Loans</h3>
                                <p id="group-liquidity-stat" class="text-3xl font-bold text-green-600">ZMW 0.00</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md text-center">
                                <h3 class="text-gray-500 font-medium">My Total Savings</h3>
                                <p id="my-savings" class="text-3xl font-bold text-gray-800">ZMW 0.00</p>
                            </div>
                        </div>
    
                         <!-- Liquidity and Chart Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                            <!-- Liquidity Table -->
                            <div class="lg:col-span-5 bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4">Group Liquidity (Monthly)</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="p-2 font-medium text-gray-600"></th>
                                                <th class="p-2 font-medium text-gray-600 text-right">JAN</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">FEB</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">MAR</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">APR</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">MAY</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">JUN</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">JUL</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">AUG</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">SEP</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">OCT</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">NOV</th>
                                                <th class="p-2 font-medium text-gray-600 text-right">DEC</th>
                                            </tr>
                                        </thead>
                                        <tbody id="liquidity-table-body" class="divide-y divide-gray-200">
                                            <!-- Data will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    
                        <!-- Members Overview Table -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Member Overview</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead id="member-overview-head" class="bg-gray-50">
                                        <!-- Header generated by JS -->
                                    </thead>
                                    <tbody id="member-overview-body">
                                        <!-- Data will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Attendance Table -->
                        <div id="attendance-section" class="hidden bg-white p-6 rounded-xl shadow-md mt-6">
                            <h3 class="text-xl font-semibold mb-4">Member Attendance</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead id="attendance-head" class="bg-gray-50">
                                        <!-- Header generated by JS -->
                                    </thead>
                                    <tbody id="attendance-body">
                                        <!-- Data will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
    
                    <!-- Deposit View -->
                    <div id="view-deposit" class="hidden">
                        <!-- Admin Control Panel -->
                        <div id="deposit-admin-panel" class="hidden bg-indigo-50 p-6 rounded-xl shadow-md mb-6 border-l-4 border-indigo-500">
                             <h2 class="text-2xl font-bold mb-4 text-gray-800">Declaration Period Control</h2>
                             <div class="flex items-center space-x-4">
                                <select id="deposit-month-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    <option selected>Choose a month...</option>
                                    <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                                    <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                                    <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                                </select>
                                <button id="open-deposits-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Open Deposits</button>
                                <button id="close-deposits-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Close Deposits</button>
                                <div>
                                    <span class="font-medium">Status:</span>
                                    <span id="deposit-status-text" class="font-bold text-gray-700"></span>
                                </div>
                             </div>
                        </div>
                        <!-- Member Deposit Form -->
                        <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-2 text-gray-800">Monthly Deposit Declaration</h2>
                            <p id="deposit-period-message" class="text-center font-semibold mb-6 p-3 rounded-md"></p>
                            <form id="deposit-form">
                                <fieldset id="deposit-fieldset">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label for="save-amount" class="block text-sm font-medium text-gray-700 mb-2">Amount to Save</label>
                                            <input type="number" id="save-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00">
                                        </div>
                                        <div>
                                            <label for="repay-amount" class="block text-sm font-medium text-gray-700 mb-2">Amount to Repay</label>
                                            <input type="number" id="repay-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00">
                                        </div>
                                        <div>
                                            <label for="borrow-amount" class="block text-sm font-medium text-gray-700 mb-2">Amount to Borrow</label>
                                            <input type="number" id="borrow-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00">
                                        </div>
                                    </div>
                                    <button id="submit-declaration-btn" type="submit" class="mt-8 w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg transition-colors cursor-not-allowed" disabled>
                                        Submit My Declaration
                                    </button>
                                </fieldset>
                            </form>
                        </div>
                    </div>

                    <!-- Request Loan View -->
                    <div id="view-request-loan" class="hidden">
                        <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-6 text-gray-800">Request a New Loan</h2>
                            <form id="loan-request-form">
                                <div class="mb-4">
                                    <label for="loan-amount" class="block text-sm font-medium text-gray-700 mb-2">Loan Amount (ZMW)</label>
                                    <input type="number" id="loan-amount" name="loan-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 5000" required>
                                    <p id="max-loan-text" class="text-xs text-gray-500 mt-1">Your current savings allow for a maximum loan of ZMW 0.00</p>
                                </div>
                                 <div class="mb-6 mt-6">
                                    <p class="text-xs text-gray-500 text-center">By submitting this loan application, you acknowledge that you have read and understood the terms in the Trust Fund Commitment Form</p>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    Submit Loan Application
                                </button>
                            </form>
                        </div>
                    </div>
    
                    <!-- My Loans View -->
                    <div id="view-my-loans" class="hidden">
                         <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">My Loan History & Status</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-3 font-medium text-gray-600">Request Date</th>
                                            <th class="p-3 font-medium text-gray-600">Amount</th>
                                            <th class="p-3 font-medium text-gray-600">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-loans-table">
                                        <!-- My loans will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
    
                     <!-- Loan Recon View -->
                    <div id="view-recon" class="hidden">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Loan Reconciliation Statements</h3>
                            <div id="recon-statements-container" class="space-y-6">
                                <!-- Statements will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
    
                    <!-- Future Value View -->
                    <div id="view-future" class="hidden">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Future Value Projections</h3>
                            <div id="future-value-container" class="overflow-x-auto">
                               <!-- Future value table will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
    
                    <!-- Penalties View -->
                    <div id="view-penalties" class="hidden">
                        <div id="penalty-admin-panel" class="hidden bg-indigo-50 p-6 rounded-xl shadow-md mb-6 border-l-4 border-indigo-500">
                             <h2 class="text-2xl font-bold mb-4 text-gray-800">Add New Penalty</h2>
                             <form id="penalty-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="penalty-member-select" class="block text-sm font-medium text-gray-700 mb-1">Member</label>
                                    <select id="penalty-member-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                        <option>Select Member...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="penalty-month-select" class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                                    <select id="penalty-month-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                        <option>Select Month...</option>
                                        <option value="1">JAN</option><option value="2">FEB</option><option value="3">MAR</option><option value="4">APR</option><option value="5">MAY</option><option value="6">JUN</option>
                                        <option value="7">JUL</option><option value="8">AUG</option><option value="9">SEP</option><option value="10">OCT</option><option value="11">NOV</option><option value="12">DEC</option>
                                    </select>
                                </div>
                                <div class="flex items-end space-x-4">
                                    <fieldset>
                                        <legend class="block text-sm font-medium text-gray-700 mb-1">Reason(s)</legend>
                                        <div class="flex items-center space-x-3 pt-1">
                                             <label class="flex items-center text-sm"><input type="checkbox" name="penalty-reason" value="Did not honor declaration" data-value="150" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1"> Declaration</label>
                                             <label class="flex items-center text-sm"><input type="checkbox" name="penalty-reason" value="Absent" data-value="100" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1"> Absent</label>
                                             <label class="flex items-center text-sm"><input type="checkbox" name="penalty-reason" value="Late for meeting" data-value="50" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1"> Late</label>
                                        </div>
                                    </fieldset>
                                    <div class="pl-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Penalty</label>
                                        <p id="penalty-total-display" class="text-2xl font-bold text-indigo-600">ZMW 0</p>
                                    </div>
                                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 self-end">Add Penalty</button>
                                </div>
                             </form>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Monthly Penalties</h3>
                            <div id="penalties-container" class="overflow-x-auto">
                               <!-- Penalties table will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
    
    
                    <!-- Admin View -->
                    <div id="view-admin" class="hidden">
                         <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Pending Loan Approvals</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-3 font-medium text-gray-600">Requestor</th>
                                            <th class="p-3 font-medium text-gray-600">Amount</th>
                                            <th class="p-3 font-medium text-gray-600">Date</th>
                                            <th class="p-3 font-medium text-gray-600 text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-approval-table">
                                        <!-- Loan requests will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
    
                    <!-- Transactions View -->
                    <div id="view-transactions" class="hidden">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h3 class="text-xl font-semibold mb-4">Monthly Savings Transactions</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[800px]">
                                    <thead id="transactions-savings-head" class="bg-gray-50"></thead>
                                    <tbody id="transactions-savings-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Monthly Loan Repayments</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[800px]">
                                    <thead id="transactions-repayments-head" class="bg-gray-50"></thead>
                                    <tbody id="transactions-repayments-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md mt-6">
                            <h3 class="text-xl font-semibold mb-4">Monthly Amounts Borrowed</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[800px]">
                                    <thead id="transactions-borrowed-head" class="bg-gray-50"></thead>
                                    <tbody id="transactions-borrowed-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
    
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>
    
    <!-- Rejection Reason Modal -->
    <div id="rejection-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Reason for Rejection</h3>
                <div class="mt-4 px-7 py-3">
                    <div class="space-y-2 text-left">
                        <label class="flex items-center">
                            <input type="radio" name="rejection-reason" value="Insufficient funds available" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-3 text-sm text-gray-700">Insufficient funds available</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="rejection-reason" value="Not Eligible to borrow that amount" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-3 text-sm text-gray-700">Not Eligible to borrow that amount</span>
                        </label>
                    </div>
                    <p id="rejection-error" class="text-red-500 text-xs italic text-center mt-2 hidden">Please select a reason.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="submit-rejection-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">Submit Rejection</button>
                    <button id="cancel-rejection-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 hover:bg-gray-300 focus:outline-none">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, Timestamp, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-l4xXZUg-r2appZESJdLWfSfkJjUr9PY",
            authDomain: "the-trust-fund-app-8ba10.firebaseapp.com",
            projectId: "the-trust-fund-app-8ba10",
            storageBucket: "the-trust-fund-app-8ba10.firebasestorage.app",
            messagingSenderId: "820543355895",
            appId: "1:820543355895:web:63ebe5b945394ca50b0cf2",
            measurementId: "G-CBF5V7EX7M"
        };
        
        // --- App Configuration ---
        const GROUP_ID = "main"; // You can change this if you run multiple groups
        const ADMIN_EMAIL = "markmoonga@gmail.com"; 

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let currentUserData = null; // To hold user profile from Firestore
        let liquidityChart = null;
        let loanIdToReject = null;
        let isInitialLoad = true;

        let allMembers = [];
        let allTransactions = [];
        let allLoans = [];
        let allPenalties = [];
        let allAttendance = [];
        let groupConfig = { isDepositPeriodOpen: false, depositMonth: null };
        
        let unsubscribeListeners = [];
        
        // --- DOM ELEMENTS (will be assigned on DOMContentLoaded) ---
        let loginContainer, authLoader, loginForm, registerForm, appContainer, loginError, registerError, logoutBtn, viewLoader, showRegisterLink, showLoginLink, views, navLinks, headerTitle, memberOverviewHead, memberOverviewBody, myLoansTable, adminApprovalTable, transactionsSavingsHead, transactionsSavingsBody, transactionsRepaymentsHead, transactionsRepaymentsBody, transactionsBorrowedHead, transactionsBorrowedBody, loanRequestForm, userInfo, notificationBell, notificationPanel, notificationList, notificationIndicator, toast, toastMessage, futureValueContainer, reconStatementsContainer, penaltiesContainer, liquidityTableBody, rejectionModal, submitRejectionBtn, cancelRejectionBtn, depositAdminPanel, depositForm, depositFieldset, depositStatusText, depositPeriodMessage, openDepositsBtn, closeDepositsBtn, depositMonthSelect, penaltyAdminPanel, penaltyForm, penaltyTotalDisplay, attendanceSection, attendanceHead, attendanceBody, submitDeclarationBtn, saveAmountInput, repayAmountInput, borrowAmountInput;
        
        // --- FORMATTERS ---
        const formatCurrency = (amount) => `ZMW ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const formatCurrencySimple = (amount) => (amount && amount != 0) ? amount.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : '-';
        const getMonthName = (monthNumber) => new Date(2025, monthNumber - 1, 1).toLocaleString('default', { month: 'long' });
        const getMonthShortName = (monthNumber) => new Date(2025, monthNumber - 1, 1).toLocaleString('default', { month: 'short' }).toUpperCase();
        
        // --- MAIN APP LOGIC ---
        function showView(viewName) {
            if(!views) return;
            Object.values(views).forEach(view => view.classList.add('hidden'));
            viewLoader.classList.add('hidden');
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
            
            Object.values(navLinks).forEach(link => link.classList.remove('active'));
            if(navLinks[viewName]) {
                navLinks[viewName].classList.add('active');
                headerTitle.textContent = navLinks[viewName].textContent.trim();
            }
        }

        function showToast(message, isError = false) {
            if(!toastMessage) return; // Guard against early calls
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
        
        function renderApp() {
            if (!currentUserData) return;
            userInfo.innerHTML = `
                <div class="font-semibold">${currentUserData.name}</div>
                <div class="text-sm text-gray-500">${currentUserData.isAdmin ? "Administrator" : "Member"}</div>
            `;
            navLinks.admin.classList.toggle('hidden', !currentUserData.isAdmin);
            navLinks.transactions.classList.toggle('hidden', !currentUserData.isAdmin);
            depositAdminPanel.classList.toggle('hidden', !currentUserData.isAdmin);
            penaltyAdminPanel.classList.toggle('hidden', !currentUserData.isAdmin);
            
            // Update max loan amount text on loan request form
            const memberStats = calculateAllMemberStats().find(m => m.id === currentUserData.id);
            const myTotalSavings = memberStats ? memberStats.totalSavings : 0;
            const maxLoanAmount = myTotalSavings * 3; // Assuming 3x savings rule
            document.getElementById('max-loan-text').textContent = `Your current savings allow for a maximum loan of ${formatCurrency(maxLoanAmount)}`;

            renderDashboard();
            renderMyLoans();
            renderAdminView();
            renderTransactions();
            renderDepositPage();
            renderFutureValue();
            renderLoanRecon();
            renderPenalties();
            renderAttendanceTable();
        }
        
        // --- DATA LISTENERS ---
        function setupListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const groupRef = doc(db, "groups", GROUP_ID);
            const unsubGroup = onSnapshot(groupRef, (snap) => {
                if (snap.exists()) {
                    groupConfig = snap.data();
                    renderDepositPage();
                }
            }, (error) => console.error("Group listener error:", error));
            unsubscribeListeners.push(unsubGroup);

            const usersQuery = query(collection(db, "groups", GROUP_ID, "members"));
            const unsubUsers = onSnapshot(usersQuery, (snap) => {
                allMembers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (isInitialLoad && allMembers.length > 0) {
                    showView('dashboard');
                    isInitialLoad = false;
                }
                renderApp(); 
            }, (error) => console.error("Members listener error:", error));
            unsubscribeListeners.push(unsubUsers);
            
            const transQuery = query(collection(db, "groups", GROUP_ID, "transactions"));
            const unsubTrans = onSnapshot(transQuery, (snap) => {
                allTransactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                renderTransactions();
                renderLoanRecon();
                renderFutureValue();
            }, (error) => console.error("Transactions listener error:", error));
            unsubscribeListeners.push(unsubTrans);

            const loansQuery = query(collection(db, "groups", GROUP_ID, "loans"));
            const unsubLoans = onSnapshot(loansQuery, (snap) => {
                allLoans = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMyLoans();
                renderAdminView();
            }, (error) => console.error("Loans listener error:", error));
            unsubscribeListeners.push(unsubLoans);

            const penaltiesQuery = query(collection(db, "groups", GROUP_ID, "penalties"));
            const unsubPenalties = onSnapshot(penaltiesQuery, (snap) => {
                allPenalties = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPenalties();
            }, (error) => console.error("Penalties listener error:", error));
            unsubscribeListeners.push(unsubPenalties);

            const attendanceQuery = query(collection(db, "groups", GROUP_ID, "attendance"));
            const unsubAttendance = onSnapshot(attendanceQuery, (snap) => {
                allAttendance = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAttendanceTable();
            }, (error) => console.error("Attendance listener error:", error));
            unsubscribeListeners.push(unsubAttendance);
        }


        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    viewLoader.classList.remove('hidden'); // Show loader while we check user data
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists()) {
                        currentUserData = { id: user.uid, ...docSnap.data() };
                        currentUser = user;
                        appContainer.classList.remove('hidden');
                        loginContainer.classList.add('hidden');
                        authLoader.classList.add('hidden');
                        setupListeners(); 
                    } else {
                        await signOut(auth);
                        showToast("Could not find user profile. Please register first.", true);
                    }
                } else {
                    appContainer.classList.add('hidden');
                    loginContainer.classList.remove('hidden');
                    authLoader.classList.add('hidden');
                    viewLoader.classList.add('hidden');
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (registerForm) registerForm.classList.add('hidden');
                    currentUser = null;
                    currentUserData = null;
                }
            } catch (error) {
                console.error("Authentication state error:", error);
                showToast("An error occurred during authentication. Please try again.", true);
                if(auth.currentUser) await signOut(auth);
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- Assign DOM Elements ---
            loginContainer = document.getElementById('login-container');
            authLoader = document.getElementById('auth-loader');
            loginForm = document.getElementById('login-form');
            registerForm = document.getElementById('register-form');
            appContainer = document.getElementById('app-container');
            loginError = document.getElementById('login-error');
            registerError = document.getElementById('register-error');
            logoutBtn = document.getElementById('logout-btn');
            viewLoader = document.getElementById('view-loader');
            showRegisterLink = document.getElementById('show-register');
            showLoginLink = document.getElementById('show-login');
            
            views = {
                dashboard: document.getElementById('view-dashboard'),
                deposit: document.getElementById('view-deposit'),
                requestLoan: document.getElementById('view-request-loan'),
                myLoans: document.getElementById('view-my-loans'),
                recon: document.getElementById('view-recon'),
                future: document.getElementById('view-future'),
                penalties: document.getElementById('view-penalties'),
                admin: document.getElementById('view-admin'),
                transactions: document.getElementById('view-transactions'),
            };
            navLinks = {
                dashboard: document.getElementById('nav-dashboard'),
                deposit: document.getElementById('nav-deposit'),
                requestLoan: document.getElementById('nav-request-loan'),
                myLoans: document.getElementById('nav-my-loans'),
                recon: document.getElementById('nav-recon'),
                future: document.getElementById('nav-future'),
                penalties: document.getElementById('nav-penalties'),
                admin: document.getElementById('nav-admin'),
                transactions: document.getElementById('nav-transactions'),
            };
            headerTitle = document.getElementById('header-title');
            memberOverviewHead = document.getElementById('member-overview-head');
            memberOverviewBody = document.getElementById('member-overview-body');
            myLoansTable = document.getElementById('my-loans-table');
            adminApprovalTable = document.getElementById('admin-approval-table');
            transactionsSavingsHead = document.getElementById('transactions-savings-head');
            transactionsSavingsBody = document.getElementById('transactions-savings-body');
            transactionsRepaymentsHead = document.getElementById('transactions-repayments-head');
            transactionsRepaymentsBody = document.getElementById('transactions-repayments-body');
            transactionsBorrowedHead = document.getElementById('transactions-borrowed-head');
            transactionsBorrowedBody = document.getElementById('transactions-borrowed-body');
            loanRequestForm = document.getElementById('loan-request-form');
            userInfo = document.getElementById('user-info');
            notificationBell = document.getElementById('notification-bell');
            notificationPanel = document.getElementById('notification-panel');
            notificationList = document.getElementById('notification-list');
            notificationIndicator = document.getElementById('notification-indicator');
            toast = document.getElementById('toast');
            toastMessage = document.getElementById('toast-message');
            futureValueContainer = document.getElementById('future-value-container');
            reconStatementsContainer = document.getElementById('recon-statements-container');
            penaltiesContainer = document.getElementById('penalties-container');
            liquidityTableBody = document.getElementById('liquidity-table-body');
            rejectionModal = document.getElementById('rejection-modal');
            submitRejectionBtn = document.getElementById('submit-rejection-btn');
            cancelRejectionBtn = document.getElementById('cancel-rejection-btn');
            depositAdminPanel = document.getElementById('deposit-admin-panel');
            depositForm = document.getElementById('deposit-form');
            depositFieldset = document.getElementById('deposit-fieldset');
            depositStatusText = document.getElementById('deposit-status-text');
            depositPeriodMessage = document.getElementById('deposit-period-message');
            openDepositsBtn = document.getElementById('open-deposits-btn');
            closeDepositsBtn = document.getElementById('close-deposits-btn');
            depositMonthSelect = document.getElementById('deposit-month-select');
            penaltyAdminPanel = document.getElementById('penalty-admin-panel');
            penaltyForm = document.getElementById('penalty-form');
            penaltyTotalDisplay = document.getElementById('penalty-total-display');
            attendanceSection = document.getElementById('attendance-section');
            attendanceHead = document.getElementById('attendance-head');
            attendanceBody = document.getElementById('attendance-body');
            submitDeclarationBtn = document.getElementById('submit-declaration-btn');
            saveAmountInput = document.getElementById('save-amount');
            repayAmountInput = document.getElementById('repay-amount');
            borrowAmountInput = document.getElementById('borrow-amount');

            // --- Attach Event Listeners ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authLoader.classList.remove('hidden');
                loginForm.classList.add('hidden');
                loginError.classList.add('hidden');
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                    authLoader.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authLoader.classList.remove('hidden');
                registerForm.classList.add('hidden');
                registerError.classList.add('hidden');

                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    const newUser = {
                        name: name,
                        email: email,
                        isAdmin: email.toLowerCase() === ADMIN_EMAIL,
                    };

                    await setDoc(doc(db, "users", user.uid), newUser);
                    
                    const newMember = {
                        name: name,
                        email: email,
                        userId: user.uid,
                    };
                    await setDoc(doc(db, "groups", GROUP_ID, "members", user.uid), newMember);


                } catch(error) {
                    registerError.textContent = error.message;
                    registerError.classList.remove('hidden');
                    authLoader.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                isInitialLoad = true; // Reset on logout
                unsubscribeListeners.forEach(unsub => unsub()); // Detach listeners
                unsubscribeListeners = [];
                signOut(auth);
            });

            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            Object.keys(navLinks).forEach(key => {
                navLinks[key].addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(key);
                });
            });

            // --- Added Event Listeners for Forms and Buttons ---
            openDepositsBtn.addEventListener('click', handleOpenDeposits);
            closeDepositsBtn.addEventListener('click', handleCloseDeposits);
            depositForm.addEventListener('submit', handleSubmitDeclaration);
            loanRequestForm.addEventListener('submit', handleSubmitLoanRequest);
            submitRejectionBtn.addEventListener('click', handleSubmitRejection);
            cancelRejectionBtn.addEventListener('click', () => {
                rejectionModal.classList.add('hidden');
                document.getElementById('rejection-error').classList.add('hidden');
                loanIdToReject = null;
            });
            penaltyForm.addEventListener('submit', handleAddPenalty);
            document.querySelectorAll('input[name="penalty-reason"]').forEach(cb => {
                cb.addEventListener('change', updateTotalPenalty);
            });

            attendanceBody.addEventListener('click', handleAttendanceClick);

            // --- Declaration form validation ---
            const inputsToValidate = [saveAmountInput, repayAmountInput, borrowAmountInput];
            inputsToValidate.forEach(input => {
                if(input) input.addEventListener('input', validateDeclarationForm);
            });
            validateDeclarationForm(); // Initial check

        });
        
        // --- RENDER FUNCTIONS AND OTHER LOGIC ---
        
        // --- Declaration Form Validation ---
        function validateDeclarationForm() {
            if (!submitDeclarationBtn || !saveAmountInput || !repayAmountInput || !borrowAmountInput) return;
            
            // A value of '0' is valid, but an empty string is not.
            const isSaveValid = saveAmountInput.value.trim() !== '';
            const isRepayValid = repayAmountInput.value.trim() !== '';
            const isBorrowValid = borrowAmountInput.value.trim() !== '';

            if (isSaveValid && isRepayValid && isBorrowValid) {
                submitDeclarationBtn.disabled = false;
                submitDeclarationBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitDeclarationBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                submitDeclarationBtn.disabled = true;
                submitDeclarationBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitDeclarationBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            }
        };

        // --- Dashboard Rendering ---
        function renderDashboard() {
            if (!allMembers.length || !currentUserData) {
                return;
            }

            const memberData = calculateAllMemberStats();
            
            // Calculate overall group stats
            const totalGroupSavings = memberData.reduce((sum, member) => sum + member.totalSavings, 0);
            const totalLoansOut = memberData.reduce((sum, member) => sum + member.loanBalance, 0);
            const availableLiquidity = totalGroupSavings - totalLoansOut;
            const mySavings = memberData.find(m => m.id === currentUserData.id)?.totalSavings || 0;

            // Update stat cards
            document.getElementById('group-savings-stat').textContent = formatCurrency(totalGroupSavings);
            document.getElementById('group-liquidity-stat').textContent = formatCurrency(availableLiquidity);
            document.getElementById('my-savings').textContent = formatCurrency(mySavings);

            // Update Member Overview Table
            renderMemberOverviewTable(memberData);
            
            // Update Liquidity Table
            renderLiquiditySection();
        }

        function renderMemberOverviewTable(memberData) {
            // Header for Member Overview
            let headHTML = `
                <tr>
                    <th class="p-3 font-medium text-gray-600 text-center">NAME</th>
                    <th class="p-3 font-medium text-gray-600 text-center">SAVED</th>
                    <th class="p-3 font-medium text-gray-600 text-center">EARNED</th>
                    <th class="p-3 font-medium text-gray-600 text-center">MAX LEVERAGE (2.5x)</th>
                    <th class="p-3 font-medium text-gray-600 text-center">LOAN BALANCE</th>
                    <th class="p-3 font-medium text-gray-600 text-center">AVAILABLE LEVERAGE</th>
                    <th class="p-3 font-medium text-gray-600 text-center">PENALTIES</th>
                    <th class="p-3 font-medium text-gray-600 text-center">ELIGIBLE TO BORROW</th>
                    <th class="p-3 font-medium text-gray-600 text-center">NET EARNINGS</th>
                </tr>`;
            memberOverviewHead.innerHTML = headHTML;

            // Body for Member Overview
            let bodyHTML = '';
            const sortedMemberData = [...memberData].sort((a, b) => a.name.localeCompare(b.name));

            sortedMemberData.forEach(data => {
                if (!data) return;
                
                const eligibilityIcon = data.isEligibleToBorrow
                    ? `<svg class="w-6 h-6 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                    : `<svg class="w-6 h-6 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

                bodyHTML += `<tr class="border-b">`;
                bodyHTML += `<td class="p-3 font-medium ${data.id === currentUserData.id ? 'text-indigo-600' : ''}">${data.name}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.totalSavings)}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.earned)}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.maxLeverage)}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.loanBalance)}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.availableLeverage)}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.totalPenalties)}</td>`;
                bodyHTML += `<td class="p-3 text-center">${eligibilityIcon}</td>`;
                bodyHTML += `<td class="p-3 text-right tabular-nums">${formatCurrencySimple(data.netEarnings)}</td>`;
                bodyHTML += `</tr>`;
            });
            memberOverviewBody.innerHTML = bodyHTML;
        }

        function renderLiquiditySection() {
            const monthlyData = calculateMonthlyLiquidity();

            // Update Liquidity Table
            let tableBodyHtml = '';
            const rows = ['Balance b/f', 'Saved', 'Repaid', 'Avl For Borrowing', 'Borrowed', 'Balance c/f'];
            rows.forEach(row => {
                tableBodyHtml += `<tr class="border-b"><td class="p-2 font-medium">${row}</td>`;
                for (let i = 1; i <= 12; i++) { 
                    let value = 0;
                    switch (row) {
                        case 'Balance b/f': value = monthlyData[i].balanceBf; break;
                        case 'Saved': value = monthlyData[i].savings; break;
                        case 'Repaid': value = monthlyData[i].repayments; break;
                        case 'Avl For Borrowing': value = monthlyData[i].totalIn; break;
                        case 'Borrowed': value = monthlyData[i].loansOut; break;
                        case 'Balance c/f': value = monthlyData[i].liquidity; break;
                    }
                    tableBodyHtml += `<td class="p-2 text-right tabular-nums">${formatCurrencySimple(value)}</td>`;
                }
                tableBodyHtml += `</tr>`;
            });
            liquidityTableBody.innerHTML = tableBodyHtml;

            // Destroy the old chart if it exists, but don't create a new one.
            if (liquidityChart) {
                liquidityChart.destroy();
                liquidityChart = null;
            }
        }
        
        // --- Attendance Table Rendering ---
        function renderAttendanceTable() {
            if (!currentUserData || !allMembers.length) return;

            // Show to everyone, but editing is handled by handleAttendanceClick admin check
            attendanceSection.classList.remove('hidden');

            // 1. Render Header
            let headHTML = '<tr><th class="p-2 font-medium text-gray-600">Member</th>';
            for (let i = 1; i <= 12; i++) {
                headHTML += `<th class="p-2 font-medium text-gray-600 text-center">${getMonthShortName(i)}</th>`;
            }
            headHTML += '</tr>';
            attendanceHead.innerHTML = headHTML;

            // 2. Render Body
            let bodyHTML = '';
            const sortedMembers = [...allMembers].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedMembers.forEach(member => {
                const memberAttendance = allAttendance.find(a => a.id === member.id) || {};
                bodyHTML += `<tr class="border-b">`;
                bodyHTML += `<td class="p-2 font-medium">${member.name}</td>`;
                for (let i = 1; i <= 12; i++) {
                    const status = memberAttendance[i] || 'none'; // 'none' for default styling
                    let symbol = '';
                    switch(status) {
                        case 'present': symbol = 'P'; break;
                        case 'absent': symbol = 'A'; break;
                        case 'late': symbol = 'L'; break;
                        default: symbol = '-';
                    }
                    bodyHTML += `<td class="attendance-cell status-${status}" data-user-id="${member.id}" data-month="${i}" data-status="${status}">${symbol}</td>`;
                }
                bodyHTML += `</tr>`;
            });
            attendanceBody.innerHTML = bodyHTML;
        }

        // --- My Loans Rendering ---
        function renderMyLoans() {
            if (!currentUserData || !allLoans) return;

            const myLoans = allLoans.filter(loan => loan.userId === currentUserData.id)
                                    .sort((a,b) => b.requestDate.seconds - a.requestDate.seconds);
            
            if (myLoans.length === 0) {
                myLoansTable.innerHTML = `<tr><td colspan="3" class="text-center p-4">You have not requested any loans.</td></tr>`;
                return;
            }

            let html = '';
            myLoans.forEach(loan => {
                const date = loan.requestDate.toDate().toLocaleDateString();
                let statusBadge = '';
                switch (loan.status) {
                    case 'approved': statusBadge = '<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Approved</span>'; break;
                    case 'pending': statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Pending</span>'; break;
                    case 'rejected': statusBadge = `<span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Rejected</span> <span class="text-xs text-gray-500">(${loan.rejectionReason || 'No reason given'})</span>`; break;
                }
                html += `
                    <tr class="border-b">
                        <td class="p-3">${date}</td>
                        <td class="p-3">${formatCurrency(loan.amount)}</td>
                        <td class="p-3">${statusBadge}</td>
                    </tr>
                `;
            });
            myLoansTable.innerHTML = html;
        }

        // --- Admin View Rendering ---
        function renderAdminView() {
            if (!currentUserData || !currentUserData.isAdmin || !allLoans || !allMembers) return;

            const pendingLoans = allLoans.filter(loan => loan.status === 'pending')
                                         .sort((a,b) => a.requestDate.seconds - b.requestDate.seconds);

            if (pendingLoans.length === 0) {
                adminApprovalTable.innerHTML = `<tr><td colspan="4" class="text-center p-4">No pending loan approvals.</td></tr>`;
                return;
            }

            let html = '';
            pendingLoans.forEach(loan => {
                const member = allMembers.find(m => m.userId === loan.userId);
                const date = loan.requestDate.toDate().toLocaleDateString();
                html += `
                    <tr class="border-b" data-loan-id="${loan.id}">
                        <td class="p-3">${member ? member.name : 'Unknown Member'}</td>
                        <td class="p-3">${formatCurrency(loan.amount)}</td>
                        <td class="p-3">${date}</td>
                        <td class="p-3 text-center">
                            <button class="approve-loan-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Approve</button>
                            <button class="reject-loan-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 ml-2">Reject</button>
                        </td>
                    </tr>
                `;
            });
            adminApprovalTable.innerHTML = html;

            // Add event listeners after rendering
            document.querySelectorAll('.approve-loan-btn').forEach(btn => {
                btn.addEventListener('click', handleApproveLoan);
            });
            document.querySelectorAll('.reject-loan-btn').forEach(btn => {
                btn.addEventListener('click', handleRejectLoan);
            });
        }
        
        // --- Transactions Page Rendering (Admin Editable) ---
        function renderTransactions() {
            if (!currentUserData || !allMembers.length) return;

            const renderTable = (type, headElement, bodyElement) => {
                // Header
                let headHTML = '<tr><th class="p-2 font-medium text-gray-600">Member</th>';
                for (let i = 1; i <= 12; i++) {
                    headHTML += `<th class="p-2 font-medium text-gray-600 text-right">${getMonthShortName(i)}</th>`;
                }
                headHTML += '</tr>';
                headElement.innerHTML = headHTML;

                // Body
                let bodyHTML = '';
                const sortedMembers = [...allMembers].sort((a, b) => a.name.localeCompare(b.name));
                sortedMembers.forEach(member => {
                    bodyHTML += `<tr class="border-b"><td class="p-2 font-medium">${member.name}</td>`;
                    for (let i = 1; i <= 12; i++) {
                        const transaction = allTransactions.find(t => t.userId === member.id && t.month === i && t.type === type);
                        const amount = transaction ? transaction.amount : 0;
                        const editableClass = currentUserData.isAdmin ? 'editable-cell cursor-pointer' : '';
                        bodyHTML += `<td class="p-1 text-right tabular-nums ${editableClass}" data-member-id="${member.id}" data-month="${i}" data-type="${type}">${formatCurrencySimple(amount)}</td>`;
                    }
                    bodyHTML += '</tr>';
                });
                bodyElement.innerHTML = bodyHTML;

                // Add event listeners for admin ONLY
                if (currentUserData.isAdmin) {
                    bodyElement.querySelectorAll('.editable-cell').forEach(cell => {
                        cell.addEventListener('dblclick', makeCellEditable);
                    });
                }
            };

            renderTable('save', transactionsSavingsHead, transactionsSavingsBody);
            renderTable('repay', transactionsRepaymentsHead, transactionsRepaymentsBody);
            renderTable('borrow', transactionsBorrowedHead, transactionsBorrowedBody);
        }
        
        // --- Other Page Render Stubs ---
        function renderLoanRecon() {
            if (!reconStatementsContainer) return;
            // TODO: Implement loan reconciliation logic
            reconStatementsContainer.innerHTML = `<p class="text-center text-gray-500">Loan reconciliation view is under construction.</p>`;
        }

        function renderFutureValue() {
            if (!futureValueContainer) return;
            // TODO: Implement future value logic
            futureValueContainer.innerHTML = `<p class="text-center text-gray-500">Future value projection is under construction.</p>`;
        }
        
        function renderPenalties() {
            if (!penaltiesContainer || !penaltyAdminPanel) return;
            
            if (currentUserData && currentUserData.isAdmin && allMembers.length > 0) {
                const select = document.getElementById('penalty-member-select');
                const existingValue = select.value;
                let optionsHTML = '<option value="">Select Member...</option>';
                allMembers.sort((a, b) => a.name.localeCompare(b.name)).forEach(member => {
                    optionsHTML += `<option value="${member.id}">${member.name}</option>`;
                });
                select.innerHTML = optionsHTML;
                select.value = existingValue; // Preserve selection
            }

            // TODO: Display penalties table
            penaltiesContainer.innerHTML = `<p class="text-center text-gray-500">Penalties table view is under construction.</p>`;
        }

        // --- Deposit Page Rendering & Logic ---
        function renderDepositPage() {
            if (!groupConfig) return;

            const { isDepositPeriodOpen, depositMonth } = groupConfig;
            const monthName = depositMonth ? getMonthName(depositMonth) : '';

            depositStatusText.textContent = isDepositPeriodOpen ? `Open for ${monthName}` : 'Closed';
            depositStatusText.className = `font-bold ${isDepositPeriodOpen ? 'text-green-600' : 'text-red-600'}`;

            if (isDepositPeriodOpen) {
                depositPeriodMessage.textContent = `The deposit period for ${monthName} is now open. Please submit your declaration.`;
                depositPeriodMessage.className = 'text-center font-semibold mb-6 p-3 rounded-md bg-green-100 text-green-800';
                depositFieldset.disabled = false;
            } else {
                depositPeriodMessage.textContent = 'The deposit period is currently closed.';
                depositPeriodMessage.className = 'text-center font-semibold mb-6 p-3 rounded-md bg-yellow-100 text-yellow-800';
                depositFieldset.disabled = true;
            }
        }
        
        // --- EVENT HANDLERS & ACTIONS ---
        async function handleAttendanceClick(e) {
            if (!currentUserData.isAdmin || !e.target.matches('.attendance-cell')) {
                return;
            }

            const cell = e.target;
            const userId = cell.dataset.userId;
            const month = cell.dataset.month;
            const currentStatus = cell.dataset.status;

            const statusCycle = {
                'none': 'present',
                'present': 'late',
                'late': 'absent',
                'absent': 'none',
            };

            const newStatus = statusCycle[currentStatus];
            
            try {
                const attendanceRef = doc(db, "groups", GROUP_ID, "attendance", userId);
                if (newStatus === 'none') {
                    // If the new status is 'none', remove the field from the document
                    await updateDoc(attendanceRef, { [month]: deleteField() });
                } else {
                    // Otherwise, set or update the field
                    await setDoc(attendanceRef, { [month]: newStatus }, { merge: true });
                }
                // No need for a toast here, the UI update is instant and feels more responsive
            } catch (error) {
                console.error("Error updating attendance:", error);
                showToast("Failed to update attendance.", true);
            }
        }

        async function handleOpenDeposits() {
            const month = parseInt(depositMonthSelect.value);
            if (isNaN(month)) {
                showToast('Please select a valid month.', true);
                return;
            }
            const groupRef = doc(db, "groups", GROUP_ID);
            try {
                await updateDoc(groupRef, {
                    isDepositPeriodOpen: true,
                    depositMonth: month
                });
                showToast(`Deposit period opened for ${getMonthName(month)}.`);
            } catch (error) {
                console.error("Error opening deposits:", error);
                showToast('Failed to open deposits.', true);
            }
        }

        async function handleCloseDeposits() {
            const groupRef = doc(db, "groups", GROUP_ID);
            try {
                await updateDoc(groupRef, {
                    isDepositPeriodOpen: false
                });
                showToast('Deposit period has been closed.');
            } catch (error) {
                console.error("Error closing deposits:", error);
                showToast('Failed to close deposits.', true);
            }
        }
        
        async function handleSubmitDeclaration(e) {
            e.preventDefault();
            if (!groupConfig.isDepositPeriodOpen || !currentUserData) return;

            const saveAmount = parseFloat(document.getElementById('save-amount').value) || 0;
            const repayAmount = parseFloat(document.getElementById('repay-amount').value) || 0;
            const borrowAmount = parseFloat(document.getElementById('borrow-amount').value) || 0;
            
            try {
                const batch = writeBatch(db);
                const month = groupConfig.depositMonth;

                const declarationRef = doc(db, "groups", GROUP_ID, "declarations", `${currentUserData.id}_${month}`);
                batch.set(declarationRef, {
                    userId: currentUserData.id,
                    userName: currentUserData.name,
                    month: month,
                    saveAmount,
                    repayAmount,
                    borrowAmount,
                    declaredAt: Timestamp.now()
                }, { merge: true });

                // Add transactions for save and repay directly from declaration
                if (saveAmount > 0) {
                    const saveTransRef = doc(collection(db, "groups", GROUP_ID, "transactions"));
                    batch.set(saveTransRef, {
                        userId: currentUserData.id,
                        month: month,
                        type: 'save',
                        amount: saveAmount,
                        date: Timestamp.now()
                    });
                }
                if (repayAmount > 0) {
                    const repayTransRef = doc(collection(db, "groups", GROUP_ID, "transactions"));
                    batch.set(repayTransRef, {
                        userId: currentUserData.id,
                        month: month,
                        type: 'repay',
                        amount: repayAmount,
                        date: Timestamp.now()
                    });
                }

                if (borrowAmount > 0) {
                    const loanRef = doc(collection(db, "groups", GROUP_ID, "loans"));
                    batch.set(loanRef, {
                        userId: currentUserData.id,
                        amount: borrowAmount,
                        requestDate: Timestamp.now(),
                        status: 'pending'
                    });

                    // Also add the 'borrow' transaction immediately
                    const borrowTransRef = doc(collection(db, "groups", GROUP_ID, "transactions"));
                    batch.set(borrowTransRef, {
                        userId: currentUserData.id,
                        month: month,
                        type: 'borrow',
                        amount: borrowAmount,
                        date: Timestamp.now()
                    });
                }
                
                await batch.commit();
                showToast('Your declaration has been submitted successfully!');
                depositForm.reset();
                validateDeclarationForm(); // Re-validate to disable button

            } catch (error) {
                console.error("Error submitting declaration: ", error);
                showToast("Failed to submit declaration.", true);
            }
        }

        async function handleSubmitLoanRequest(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('loan-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showToast("Please enter a valid loan amount.", true);
                return;
            }
            
            try {
                await addDoc(collection(db, "groups", GROUP_ID, "loans"), {
                    userId: currentUserData.id,
                    amount: amount,
                    requestDate: Timestamp.now(),
                    status: 'pending'
                });
                showToast("Loan request submitted successfully!");
                loanRequestForm.reset();
                showView('myLoans');
            } catch (error) {
                console.error("Error submitting loan request:", error);
                showToast("Failed to submit loan request.", true);
            }
        }

        async function handleApproveLoan(e) {
            const loanId = e.target.closest('tr').dataset.loanId;
            const loanRef = doc(db, "groups", GROUP_ID, "loans", loanId);
            try {
                // The 'borrow' transaction is now created at declaration time.
                // This function just needs to approve the loan status.
                await updateDoc(loanRef, { status: 'approved' });
                showToast('Loan approved successfully!');
            } catch (error) {
                console.error("Error approving loan: ", error);
                showToast('Error approving loan.', true);
            }
        }

        function handleRejectLoan(e) {
            loanIdToReject = e.target.closest('tr').dataset.loanId;
            rejectionModal.classList.remove('hidden');
        }

        async function handleSubmitRejection() {
            const reasonEl = document.querySelector('input[name="rejection-reason"]:checked');
            if (!reasonEl) {
                document.getElementById('rejection-error').classList.remove('hidden');
                return;
            }
            document.getElementById('rejection-error').classList.add('hidden');
            const reason = reasonEl.value;

            if (!loanIdToReject) return;

            const loanRef = doc(db, "groups", GROUP_ID, "loans", loanIdToReject);
            try {
                await updateDoc(loanRef, {
                    status: 'rejected',
                    rejectionReason: reason
                });
                showToast("Loan has been rejected.");
                rejectionModal.classList.add('hidden');
                loanIdToReject = null;
            } catch (error) {
                console.error("Error rejecting loan:", error);
                showToast("Failed to reject loan.", true);
            }
        }

        function updateTotalPenalty() {
            let total = 0;
            document.querySelectorAll('input[name="penalty-reason"]:checked').forEach(cb => {
                total += parseInt(cb.dataset.value);
            });
            penaltyTotalDisplay.textContent = `ZMW ${total}`;
        }

        async function handleAddPenalty(e) {
            e.preventDefault();
            const memberId = document.getElementById('penalty-member-select').value;
            const month = parseInt(document.getElementById('penalty-month-select').value);
            const reasons = Array.from(document.querySelectorAll('input[name="penalty-reason"]:checked')).map(cb => cb.value);
            const totalAmount = Array.from(document.querySelectorAll('input[name="penalty-reason"]:checked')).reduce((sum, cb) => sum + parseInt(cb.dataset.value), 0);

            if (!memberId || isNaN(month) || reasons.length === 0) {
                showToast('Please fill out all penalty fields.', true);
                return;
            }
            
            try {
                await addDoc(collection(db, "groups", GROUP_ID, "penalties"), {
                    userId: memberId,
                    month: month,
                    reasons: reasons,
                    amount: totalAmount,
                    createdAt: Timestamp.now()
                });
                showToast('Penalty added successfully!');
                penaltyForm.reset();
                updateTotalPenalty();
            } catch (error) {
                console.error("Error adding penalty:", error);
                showToast('Failed to add penalty.', true);
            }
        }
        
        // --- Editable Cells Logic (Admin) ---
        function makeCellEditable(e) {
            const cell = e.currentTarget;
            if (cell.querySelector('input')) return; // Already in edit mode

            const originalValue = cell.textContent.replace(/,/g, '') || '0';
            cell.innerHTML = `<input type="text" value="${originalValue}" class="w-full text-right"/>`;
            const input = cell.querySelector('input');
            input.focus();
            input.select();

            input.addEventListener('blur', () => saveCell(cell, input.value));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    revertCell(cell, originalValue);
                }
            });
        }
        
        async function saveCell(cell, newValue) {
            const memberId = cell.dataset.memberId;
            const month = parseInt(cell.dataset.month);
            const type = cell.dataset.type;
            const amount = parseFloat(newValue) || 0;
            
            cell.innerHTML = formatCurrencySimple(amount);

            try {
                const batch = writeBatch(db);

                // Find and delete existing transactions for this member/month/type
                const q = query(collection(db, "groups", GROUP_ID, "transactions"), 
                    where("userId", "==", memberId),
                    where("month", "==", month),
                    where("type", "==", type)
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                // Add the new transaction if amount is not zero
                if (amount > 0) {
                    const newTransRef = doc(collection(db, "groups", GROUP_ID, "transactions"));
                     batch.set(newTransRef, {
                        userId: memberId,
                        month: month,
                        type: type,
                        amount: amount,
                        date: Timestamp.fromDate(new Date(2025, month-1, 15)) // Arbitrary date in the month
                    });
                }
               
                await batch.commit();
                showToast('Transaction updated successfully!');
            } catch (error) {
                 console.error("Error updating transaction: ", error);
                 showToast('Error updating transaction.', true);
                 const originalTransaction = allTransactions.find(t => t.userId === memberId && t.month === month && t.type === type);
                 cell.innerHTML = formatCurrencySimple(originalTransaction ? originalTransaction.amount : 0);
            }
        }
        
        function revertCell(cell, originalValue) {
             cell.innerHTML = formatCurrencySimple(parseFloat(originalValue));
        }

        // --- CALCULATION LOGIC ---
        function calculateAllMemberStats() {
            if (!allMembers.length) return [];

            // 1. Calculate group-wide totals first
            const totalGroupRepayments = allTransactions.filter(t => t.type === 'repay').reduce((sum, t) => sum + t.amount, 0);
            const totalGroupLoansOut = allTransactions.filter(t => t.type === 'borrow').reduce((sum, t) => sum + t.amount, 0);
            const totalGroupSavings = allTransactions.filter(t => t.type === 'save').reduce((sum, t) => sum + t.amount, 0);
            const totalGroupPenalties = allPenalties.reduce((sum, p) => sum + p.amount, 0);

            // Profit is the interest portion of repayments (assuming 10% interest for this example) plus penalties.
            // This is a simplified model. A real model would track principal vs. interest.
            const interestRate = 0.10; 
            const totalInterestPaid = (totalGroupRepayments / (1 + interestRate)) * interestRate; // Approximate interest
            const totalGroupProfit = totalInterestPaid + totalGroupPenalties;

            // 2. Calculate stats for each member
            return allMembers.map(member => {
                if (!member) return null;
                
                const totalSavings = allTransactions
                    .filter(t => t.userId === member.id && t.type === 'save')
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalRepaid = allTransactions
                    .filter(t => t.userId === member.id && t.type === 'repay')
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalBorrowed = allTransactions
                    .filter(t => t.userId === member.id && t.type === 'borrow')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                // Assuming 10% interest on borrowed amount to calculate loan balance
                const loanBalance = (totalBorrowed * (1 + interestRate)) - totalRepaid;
                
                const totalPenalties = allPenalties
                    .filter(p => p.userId === member.id)
                    .reduce((sum, p) => sum + p.amount, 0);

                // --- NEW Column Calculations ---
                const earned = totalGroupSavings > 0 ? (totalSavings / totalGroupSavings) * totalGroupProfit : 0;
                const maxLeverage = totalSavings * 2.5; // Logic updated
                const availableLeverage = maxLeverage - loanBalance;
                const isEligibleToBorrow = availableLeverage >= 0; // Logic updated to a check
                const netEarnings = earned - (loanBalance + totalPenalties); // Logic updated

                return {
                    id: member.id,
                    name: member.name,
                    totalSavings,
                    loanBalance,
                    totalPenalties,
                    earned,
                    maxLeverage,
                    availableLeverage,
                    isEligibleToBorrow,
                    netEarnings
                };
            }).filter(Boolean); // Remove any nulls if a member was deleted but their data remains
        }

        function calculateMonthlyLiquidity() {
            const monthlyData = {};
            let openingBalance = 0;

            for (let i = 1; i <= 12; i++) {
                const savings = allTransactions.filter(t => t.month === i && t.type === 'save').reduce((sum, t) => sum + t.amount, 0);
                const repayments = allTransactions.filter(t => t.month === i && t.type === 'repay').reduce((sum, t) => sum + t.amount, 0);
                const loansOut = allTransactions.filter(t => t.month === i && t.type === 'borrow').reduce((sum, t) => sum + t.amount, 0);
                
                const balanceBf = openingBalance;
                const totalIn = balanceBf + savings + repayments;
                const liquidity = totalIn - loansOut;

                monthlyData[i] = {
                    balanceBf,
                    savings,
                    repayments,
                    totalIn,
                    loansOut,
                    liquidity
                };
                
                openingBalance = liquidity; // The closing balance for this month is the opening for the next
            }
            return monthlyData;
        }

    </script>
</body>
</html>



